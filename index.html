<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SARTHAK AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s; }
        #loading { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: white; z-index: 9999; }
        .dark #loading { background: #131314; color: white; }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .prose pre { background: #f3f4f6; padding: 1rem; border-radius: 0.8rem; overflow-x: auto; }
        .dark .prose pre { background: #1e1e1f; border: 1px solid #333; }
        .chat-bubble { max-width: 85%; line-height: 1.6; }
    </style>
</head>
<body class="bg-white dark:bg-[#131314] text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

    <div id="loading">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-blue-500 mb-4"></div>
            <p class="text-sm font-medium animate-pulse">SARTHAK AI is waking up...</p>
        </div>
    </div>

    <div id="app" class="hidden flex flex-1 overflow-hidden h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-gray-50 dark:bg-[#1e1e1f] transform -translate-x-full lg:translate-x-0 lg:static lg:block border-r border-gray-200 dark:border-gray-800 flex flex-col">
            <div class="p-6 flex items-center justify-between">
                <h1 class="font-bold text-xl text-blue-600 dark:text-blue-400">SARTHAK AI</h1>
                <button onclick="toggleSidebar()" class="lg:hidden p-2 text-gray-500">‚úï</button>
            </div>
            
            <button onclick="createNewChat()" class="mx-4 mb-6 flex items-center gap-3 bg-white dark:bg-[#2b2b2c] p-4 rounded-2xl shadow-sm hover:shadow-md transition-all border border-gray-100 dark:border-gray-700">
                <span class="text-blue-500 text-lg font-bold">+</span> <span class="text-sm font-semibold">New Chat</span>
            </button>

            <div id="chat-history" class="flex-1 overflow-y-auto px-3 space-y-1"></div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800 space-y-1">
                <button onclick="toggleDarkMode()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-xl transition text-sm">
                    <span id="theme-icon">üåô</span> Appearance
                </button>
                <button onclick="openSettings()" class="w-full flex items-center gap-3 p-3 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-xl transition text-sm">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative min-w-0">
            <header class="p-4 flex items-center gap-4 lg:hidden">
                <button onclick="toggleSidebar()" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-lg">‚ò∞</button>
                <span class="font-bold">SARTHAK AI</span>
            </header>

            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-8">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto">
                    <div class="w-16 h-16 bg-blue-600 rounded-2xl mb-6 flex items-center justify-center shadow-lg shadow-blue-500/20">
                        <span class="text-white text-3xl font-bold">S</span>
                    </div>
                    <h2 class="text-4xl font-bold mb-4 tracking-tight">How can I help you today?</h2>
                    <p class="text-gray-500 dark:text-gray-400 text-lg">I'm your AI assistant, powered by Gemini and DeepSeek. Ask me anything.</p>
                </div>
            </div>

            <div class="p-4 md:pb-10 w-full max-w-4xl mx-auto">
                <div class="relative flex items-end bg-gray-100 dark:bg-[#1e1e1f] rounded-[28px] p-2 pr-4 shadow-sm border border-transparent focus-within:border-gray-300 dark:focus-within:border-gray-600 transition-all">
                    <textarea id="user-input" rows="1" placeholder="Message SARTHAK AI..." class="w-full bg-transparent border-none focus:ring-0 p-4 max-h-48 resize-none text-base"></textarea>
                    <button id="send-btn" onclick="handleSendMessage()" class="mb-2 p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors disabled:opacity-30">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </div>
                <p class="text-[11px] text-center mt-3 text-gray-400">Powered by OpenRouter. Built for speed.</p>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1e1e1f] w-full max-w-md rounded-3xl p-8 shadow-2xl animate-in fade-in zoom-in duration-200">
            <h3 class="text-2xl font-bold mb-6">Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-2">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-[#2b2b2c] border-none focus:ring-2 ring-blue-500" placeholder="sk-or-...">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-2">Preferred Model</label>
                    <input type="text" id="model-input" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-[#2b2b2c] border-none focus:ring-2 ring-blue-500" placeholder="deepseek/deepseek-r1:free">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-8">
                <button onclick="closeSettings()" class="px-5 py-2 font-medium">Cancel</button>
                <button onclick="saveSettings()" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-all">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION (PASTE YOUR KEY HERE)
        // ==========================================
        const DEFAULT_CONFIG = {
            apiKey: "PASTE_YOUR_GEMINI_API_KEY_HERE", // Replace this
            model: "google/gemini-2.0-flash-exp:free"
        };

        let state = {
            apiKey: localStorage.getItem('sarthak_key') || DEFAULT_CONFIG.apiKey,
            model: localStorage.getItem('sarthak_model') || DEFAULT_CONFIG.model,
            chats: JSON.parse(localStorage.getItem('sarthak_chats')) || [],
            currentChatId: null,
            isDarkMode: localStorage.getItem('sarthak_theme') === 'dark',
            isStreaming: false
        };

        // Initialize
        window.onload = () => {
            if (state.isDarkMode) document.documentElement.classList.add('dark');
            renderChatHistory();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
        };

        const textarea = document.getElementById('user-input');
        textarea.oninput = function() { 
            this.style.height = 'auto'; 
            this.style.height = this.scrollHeight + 'px'; 
        };

        textarea.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        };

        // Functions
        function createNewChat() {
            const id = Date.now().toString();
            state.chats.unshift({ id, title: 'New Conversation', messages: [] });
            state.currentChatId = id;
            save();
            switchChat(id);
            if(window.innerWidth < 1024) toggleSidebar();
        }

        async function handleSendMessage() {
            const text = textarea.value.trim();
            if (!text || state.isStreaming) return;
            if (!state.apiKey || state.apiKey.includes("PASTE_YOUR")) return openSettings();

            if (!state.currentChatId) createNewChat();
            
            addMessage('user', text);
            textarea.value = '';
            textarea.style.height = 'auto';
            
            await streamResponse(text);
        }

        async function streamResponse(prompt) {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            const msgId = Date.now().toString();
            const aiMsg = { role: 'assistant', content: '', id: msgId };
            chat.messages.push(aiMsg);

            const container = document.getElementById('chat-window');
            const bubble = createBubble('assistant', '');
            bubble.id = `ai-${msgId}`;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;

            state.isStreaming = true;
            updateBtn(true);

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: chat.messages.slice(0, -1).map(m => ({role: m.role, content: m.content})).concat([{role: 'user', content: prompt}]),
                        stream: true
                    })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let full = "";

                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    const chunks = decoder.decode(value).split('\n');
                    for(const chunk of chunks) {
                        if(!chunk.trim() || chunk.includes('data: [DONE]')) continue;
                        try {
                            const json = JSON.parse(chunk.replace('data: ', ''));
                            const content = json.choices[0].delta.content || "";
                            full += content;
                            bubble.querySelector('.prose').innerHTML = marked.parse(full);
                            aiMsg.content = full;
                            container.scrollTop = container.scrollHeight;
                        } catch(e){}
                    }
                }
                if (chat.title === 'New Conversation') chat.title = prompt.slice(0, 25) + '...';
                save();
            } catch (err) {
                bubble.querySelector('.prose').innerHTML = `<span class="text-red-500">Error connecting to AI. Please check your API key.</span>`;
            } finally {
                state.isStreaming = false;
                updateBtn(false);
            }
        }

        function createBubble(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2`;
            div.innerHTML = `
                <div class="chat-bubble p-4 rounded-2xl prose dark:prose-invert ${role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-gray-100 dark:bg-[#1e1e1f] rounded-tl-none'}">
                    ${role === 'user' ? content : (content ? marked.parse(content) : '<div class="flex gap-1"><div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div><div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:0.2s]"></div><div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce [animation-delay:0.4s]"></div></div>')}
                </div>
            `;
            return div;
        }

        function addMessage(role, content) {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role, content });
            document.getElementById('welcome-screen').style.display = 'none';
            const win = document.getElementById('chat-window');
            win.appendChild(createBubble(role, content));
            win.scrollTop = win.scrollHeight;
        }

        function switchChat(id) {
            state.currentChatId = id;
            const win = document.getElementById('chat-window');
            win.innerHTML = '';
            const chat = state.chats.find(c => c.id === id);
            if (chat.messages.length === 0) {
                win.innerHTML = `<div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto"><h2 class="text-4xl font-bold mb-4 tracking-tight">How can I help you today?</h2></div>`;
            } else {
                chat.messages.forEach(m => win.appendChild(createBubble(m.role, m.content)));
                win.scrollTop = win.scrollHeight;
            }
            renderChatHistory();
        }

        function renderChatHistory() {
            const hist = document.getElementById('chat-history');
            hist.innerHTML = state.chats.map(c => `
                <div onclick="switchChat('${c.id}')" class="flex items-center gap-3 p-3 rounded-xl cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800 transition ${state.currentChatId === c.id ? 'bg-gray-200 dark:bg-gray-800 font-medium' : ''}">
                    <span class="truncate flex-1 text-sm">üí¨ ${c.title}</span>
                    <button onclick="event.stopPropagation(); deleteChat('${c.id}')" class="text-gray-400 hover:text-red-500 text-xs">‚úï</button>
                </div>
            `).join('');
        }

        function deleteChat(id) {
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) state.currentChatId = null;
            save();
            renderChatHistory();
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        function toggleDarkMode() {
            state.isDarkMode = !state.isDarkMode;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('sarthak_theme', state.isDarkMode ? 'dark' : 'light');
        }
        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey.includes("PASTE_YOUR") ? "" : state.apiKey;
            document.getElementById('model-input').value = state.model;
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value || DEFAULT_CONFIG.apiKey;
            state.model = document.getElementById('model-input').value || DEFAULT_CONFIG.model;
            localStorage.setItem('sarthak_key', state.apiKey);
            localStorage.setItem('sarthak_model', state.model);
            closeSettings();
        }
        function save() { localStorage.setItem('sarthak_chats', JSON.stringify(state.chats)); }
        function updateBtn(loading) {
            const btn = document.getElementById('send-btn');
            btn.disabled = loading;
            btn.innerHTML = loading ? `<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>` : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>`;
        }
    </script>
</body>
</html>
        .dark .prose pre { background: #111827; }
        .prose code { font-size: 0.875rem; color: #eb5757; }
        .dark .prose { color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-[#131314] text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

    <div id="loading">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
            <p class="font-medium">Initializing SARTHAK AI...</p>
        </div>
    </div>

    <div id="app" class="hidden flex flex-1 overflow-hidden h-screen">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-gray-100 dark:bg-[#1e1e1f] transform -translate-x-full lg:translate-x-0 lg:static lg:block border-r border-gray-200 dark:border-gray-800 flex flex-col">
            <div class="p-4 flex items-center justify-between">
                <h1 class="font-bold text-xl tracking-tight text-blue-600 dark:text-blue-400">SARTHAK AI</h1>
                <button onclick="toggleSidebar()" class="lg:hidden p-2">‚úï</button>
            </div>
            
            <button onclick="createNewChat()" class="mx-4 mb-4 flex items-center gap-2 bg-white dark:bg-[#2b2b2c] p-3 rounded-2xl shadow-sm hover:shadow-md transition-all">
                <span class="text-xl">+</span> <span class="text-sm font-medium">New Chat</span>
            </button>

            <div id="chat-history" class="flex-1 overflow-y-auto px-2 space-y-1">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800 space-y-2">
                <button onclick="toggleDarkMode()" class="w-full flex items-center gap-3 p-2 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-lg transition">
                    <span id="theme-icon">üåô</span> Dark Mode
                </button>
                <button onclick="openSettings()" class="w-full flex items-center gap-3 p-2 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-lg transition">
                    <span>‚öôÔ∏è</span> Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative min-w-0 bg-white dark:bg-[#131314]">
            <header class="p-4 flex items-center gap-4 lg:hidden border-b border-gray-100 dark:border-gray-800">
                <button onclick="toggleSidebar()" class="p-2">‚ò∞</button>
                <span class="font-semibold">SARTHAK AI</span>
            </header>

            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4">
                    <h2 class="text-4xl font-bold bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">Hello, how can I help?</h2>
                    <p class="text-gray-500 max-w-md">I am Sarthak AI, your personal assistant. Ask me anything or start a new conversation.</p>
                </div>
            </div>

            <div class="p-4 md:p-6 max-w-4xl mx-auto w-full">
                <div class="relative flex items-end bg-gray-100 dark:bg-[#1e1e1f] rounded-3xl p-2 border border-transparent focus-within:border-blue-400 transition-all">
                    <textarea id="user-input" rows="1" placeholder="Enter a prompt here..." class="w-full bg-transparent border-none focus:ring-0 p-3 max-h-40 resize-none overflow-y-auto"></textarea>
                    <button id="send-btn" onclick="handleSendMessage()" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </div>
                <p class="text-[10px] text-center mt-3 text-gray-400">SARTHAK AI can make mistakes. Check important info.</p>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 z-[100] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1e1e1f] w-full max-w-md rounded-2xl p-6 space-y-4">
            <h3 class="text-xl font-bold">Settings</h3>
            <div>
                <label class="block text-sm mb-1">OpenRouter API Key</label>
                <input type="password" id="api-key-input" class="w-full p-2 rounded bg-gray-100 dark:bg-[#2b2b2c] border-none focus:ring-2 ring-blue-500" placeholder="sk-or-...">
            </div>
            <div>
                <label class="block text-sm mb-1">Model Name</label>
                <input type="text" id="model-input" class="w-full p-2 rounded bg-gray-100 dark:bg-[#2b2b2c] border-none focus:ring-2 ring-blue-500" placeholder="deepseek/deepseek-r1:free">
            </div>
            <div>
                <label class="block text-sm mb-1">System Prompt</label>
                <textarea id="system-prompt-input" rows="3" class="w-full p-2 rounded bg-gray-100 dark:bg-[#2b2b2c] border-none focus:ring-2 ring-blue-500 text-sm"></textarea>
            </div>
            <div class="flex justify-end gap-2 pt-4">
                <button onclick="closeSettings()" class="px-4 py-2 text-sm">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let state = {
            apiKey: localStorage.getItem('sarthak_key') || '',
            model: localStorage.getItem('sarthak_model') || 'deepseek/deepseek-r1:free',
            systemPrompt: localStorage.getItem('sarthak_system') || 'You are Sarthak AI, a helpful assistant.',
            chats: JSON.parse(localStorage.getItem('sarthak_chats')) || [],
            currentChatId: null,
            isDarkMode: localStorage.getItem('sarthak_theme') === 'dark',
            isStreaming: false
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            renderChatHistory();
            
            // Auto-resize textarea
            const textarea = document.getElementById('user-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            // Handle Enter Key
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            // Hide loader
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }, 500);
        });

        // --- Core Functions ---
        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'New Chat',
                messages: []
            };
            state.chats.unshift(newChat);
            state.currentChatId = newChat.id;
            saveAndRender();
            clearChatWindow();
            if(window.innerWidth < 1024) toggleSidebar();
        }

        async function handleSendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || state.isStreaming) return;
            if (!state.apiKey) return openSettings();

            if (!state.currentChatId) createNewChat();

            // Add user message
            addMessageToChat('user', text);
            input.value = '';
            input.style.height = 'auto';
            
            await callOpenRouter(text);
        }

        async function callOpenRouter(userText) {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            const messageId = Date.now().toString();
            
            // Add initial AI message bubble
            const aiMsgObj = { role: 'assistant', content: '', id: messageId };
            chat.messages.push(aiMsgObj);
            const messageElement = createMessageElement('assistant', '');
            messageElement.id = `msg-${messageId}`;
            document.getElementById('chat-window').appendChild(messageElement);
            document.getElementById('welcome-screen').classList.add('hidden');
            
            state.isStreaming = true;
            toggleLoadingState(true);

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [
                            { role: "system", content: state.systemPrompt },
                            ...chat.messages.slice(0, -1).map(m => ({ role: m.role, content: m.content })),
                            { role: "user", content: userText }
                        ],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');

                    for (const line of lines) {
                        const message = line.replace(/^data: /, '');
                        if (message === '[DONE]') break;
                        try {
                            const parsed = JSON.parse(message);
                            const content = parsed.choices[0].delta?.content || "";
                            fullText += content;
                            
                            // Update UI
                            const contentDiv = messageElement.querySelector('.prose');
                            contentDiv.innerHTML = marked.parse(fullText);
                            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
                            
                            // Update State
                            aiMsgObj.content = fullText;
                        } catch (e) {}
                    }
                }
                
                // Set Chat Title if it's the first message
                if (chat.title === 'New Chat') {
                    chat.title = userText.substring(0, 30) + '...';
                }
                saveAndRender();

            } catch (error) {
                console.error(error);
                messageElement.querySelector('.prose').innerHTML = `<span class="text-red-500">Error: Connection failed. Check API Key.</span>`;
            } finally {
                state.isStreaming = false;
                toggleLoadingState(false);
            }
        }

        // --- UI Helpers ---
        function addMessageToChat(role, content) {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role, content });
            
            const chatWindow = document.getElementById('chat-window');
            document.getElementById('welcome-screen').classList.add('hidden');
            chatWindow.appendChild(createMessageElement(role, content));
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function createMessageElement(role, content) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} w-full animate-in fade-in slide-in-from-bottom-2`;
            
            const inner = document.createElement('div');
            inner.className = `max-w-[85%] p-4 rounded-2xl prose ${
                role === 'user' 
                ? 'bg-blue-600 text-white rounded-tr-none shadow-sm' 
                : 'bg-gray-100 dark:bg-[#1e1e1f] dark:text-gray-100 rounded-tl-none'
            }`;
            
            inner.innerHTML = role === 'user' ? content : (content ? marked.parse(content) : '<span class="animate-pulse">...</span>');
            div.appendChild(inner);
            return div;
        }

        function renderChatHistory() {
            const container = document.getElementById('chat-history');
            container.innerHTML = state.chats.map(chat => `
                <div class="group relative flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800 ${state.currentChatId === chat.id ? 'bg-gray-200 dark:bg-gray-800' : ''}" onclick="switchChat('${chat.id}')">
                    <span class="truncate text-sm flex-1">üí¨ ${chat.title}</span>
                    <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        function switchChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = '';
            
            if (chat.messages.length === 0) {
                document.getElementById('welcome-screen').classList.remove('hidden');
                chatWindow.appendChild(document.getElementById('welcome-screen'));
            } else {
                chat.messages.forEach(m => chatWindow.appendChild(createMessageElement(m.role, m.content)));
            }
            
            renderChatHistory();
            if(window.innerWidth < 1024) toggleSidebar();
        }

        function deleteChat(id) {
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) {
                state.currentChatId = null;
                clearChatWindow();
            }
            saveAndRender();
        }

        function clearChatWindow() {
            const win = document.getElementById('chat-window');
            win.innerHTML = '';
            // Re-append welcome screen template
            win.innerHTML = `
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4">
                    <h2 class="text-4xl font-bold bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">Hello, how can I help?</h2>
                    <p class="text-gray-500 max-w-md">I am Sarthak AI, your personal assistant. Ask me anything or start a new conversation.</p>
                </div>
            `;
        }

        function saveAndRender() {
            localStorage.setItem('sarthak_chats', JSON.stringify(state.chats));
            renderChatHistory();
        }

        // --- Layout & Settings ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function toggleDarkMode() {
            state.isDarkMode = !state.isDarkMode;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('sarthak_theme', state.isDarkMode ? 'dark' : 'light');
            document.getElementById('theme-icon').innerText = state.isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        }

        function initTheme() {
            if (state.isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').innerText = '‚òÄÔ∏è';
            }
        }

        function openSettings() {
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model;
            document.getElementById('system-prompt-input').value = state.systemPrompt;
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value;
            state.model = document.getElementById('model-input').value;
            state.systemPrompt = document.getElementById('system-prompt-input').value;
            
            localStorage.setItem('sarthak_key', state.apiKey);
            localStorage.setItem('sarthak_model', state.model);
            localStorage.setItem('sarthak_system', state.systemPrompt);
            closeSettings();
        }

        function toggleLoadingState(loading) {
            const btn = document.getElementById('send-btn');
            btn.disabled = loading;
            btn.innerHTML = loading ? 
                `<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>` : 
                `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>`;
        }
    </script>
</body>
  </html>
              
